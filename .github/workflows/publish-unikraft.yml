name: Publish Unikernel Image

on:
  push:
    branches:
      - master
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/barffine
  KRAFT_ARCH: x86_64
  KRAFT_PLAT: qemu
  KRAFTFILE_PATH: Kraftfile

jobs:
  metadata:
    name: Prepare tags
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.image.outputs.name }}
      tags: ${{ steps.tags.outputs.list }}
    steps:
      - name: Lowercase image name
        id: image
        run: |
          IMAGE_ID=${REGISTRY}/$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "name=${IMAGE_ID}" >> "$GITHUB_OUTPUT"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Prepare tag list
        id: tags
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          raw_tags = os.environ.get('RAW_TAGS', '')
          tags = [tag.strip() for tag in raw_tags.splitlines() if tag.strip()]
          if not tags:
              tags = [os.environ['DEFAULT_TAG']]
          print(f"list={json.dumps(tags)}")
          PY
        env:
          RAW_TAGS: ${{ steps.meta.outputs.tags }}
          DEFAULT_TAG: ${{ steps.image.outputs.name }}:${{ github.sha }}

  build-and-push:
    name: Build and push (${{ matrix.tag }})
    needs: metadata
    if: needs.metadata.outputs.tags != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tag: ${{ fromJson(needs.metadata.outputs.tags) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push unikernel image
        uses: unikraft/kraftkit@staging
        with:
          workdir: .
          kraftfile: ${{ env.KRAFTFILE_PATH }}
          arch: ${{ env.KRAFT_ARCH }}
          plat: ${{ env.KRAFT_PLAT }}
          name: barffine-${{ github.sha }}
          output: oci://${{ matrix.tag }}
          push: true
