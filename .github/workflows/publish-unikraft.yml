name: Publish Unikernel Image

on:
  push:
    branches:
      - master
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/barffine
  KRAFT_ARCH: x86_64
  KRAFT_PLAT: qemu
  KRAFTFILE_PATH: Kraftfile

jobs:
  metadata:
    name: Prepare tags
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.image.outputs.name }}
      primary: ${{ steps.tags.outputs.primary }}
      extra: ${{ steps.tags.outputs.extras }}
    steps:
      - name: Lowercase image name
        id: image
        run: |
          IMAGE_ID=${REGISTRY}/$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "name=${IMAGE_ID}" >> "$GITHUB_OUTPUT"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Prepare tag list
        id: tags
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          raw_tags = os.environ.get('RAW_TAGS', '')
          tags = [tag.strip() for tag in raw_tags.splitlines() if tag.strip()]
          if not tags:
              tags = [os.environ['DEFAULT_TAG']]
          primary = next((t for t in tags if ':sha-' in t), tags[0])
          extras = [t for t in tags if t != primary]
          print(f"primary={primary}")
          print(f"extras={json.dumps(extras)}")
          PY
        env:
          RAW_TAGS: ${{ steps.meta.outputs.tags }}
          DEFAULT_TAG: ${{ steps.image.outputs.name }}:${{ github.sha }}

  build-and-push:
    name: Build and push
    needs: metadata
    if: needs.metadata.outputs.primary != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push unikernel image
        uses: unikraft/kraftkit@staging
        with:
          workdir: .
          kraftfile: ${{ env.KRAFTFILE_PATH }}
          arch: ${{ env.KRAFT_ARCH }}
          plat: ${{ env.KRAFT_PLAT }}
          name: barffine-${{ github.sha }}
          output: oci://${{ needs.metadata.outputs.primary }}
          push: true
          before: |
            set -euo pipefail
            for attempt in 1 2 3; do
              echo "Prefetching kraft packages (attempt ${attempt})"
              if kraft pkg pull --plat "${KRAFT_PLAT}" --arch "${KRAFT_ARCH}"; then
                break
              fi
              if [ "${attempt}" -eq 3 ]; then
                echo "Failed to prefetch packages after ${attempt} attempts" >&2
                exit 1
              fi
              sleep $((attempt * 5))
            done

      - name: Retag additional references
        if: ${{ needs.metadata.outputs.extra != '[]' }}
        env:
          PRIMARY_TAG: ${{ needs.metadata.outputs.primary }}
          EXTRA_TAGS: ${{ needs.metadata.outputs.extra }}
        run: |
          echo "${EXTRA_TAGS}" | jq -r '.[]' | while read TAG; do
            [ -z "${TAG}" ] && continue
            docker buildx imagetools create --tag "${TAG}" "${PRIMARY_TAG}"
          done
