# Barffine

Barffine is an [AFFiNE](https://github.com/toeverything/AFFiNE) compatible backend written in Rust, which provides a REST/GraphQL/Socket.IO/CRDT collaboration interface consistent with the official Node/TS backend with a single binary. It uses only SQLite storage, can be self-hosted in resource-constrained environments, and includes built-in migration, admin creation, document caching, and observability tools.

## Quick start

1. Install the latest stable Rust toolchain (Edition 2024 is enabled in `Cargo.toml`).
2. Copy `.env` or create a new one based on the snippet below to describe your bind address and public URL.
3. Run the server:
   ```shell
   cargo run -p barffine-server
   ```
   The default bind address is `127.0.0.1:8081` and the SQLite file is created at `./data/barffine.db`.
4. Bootstrap an admin account so AFFiNE can log in:
   ```shell
   cargo run -p barffine-server -- create-admin <email> <password>
   ```
   The command is idempotent; rerunning it rotates the password if the user already exists.
5. Verify the instance with `curl http://127.0.0.1:8081/health` and point your AFFiNE client at the same base URL.

## Operational commands
| Command | Description |
| --- | --- |
| `cargo run -p barffine-server -- serve` | Start the HTTP, GraphQL, and Socket.IO services (default subcommand). |
| `cargo run -p barffine-server -- create-admin <email> <password>` | Create or update an administrator and ensure the `admin` role is applied. |

Planned CLI parity with the Node backend (see `server/src/cli/mod.rs`) documents future subcommands such as `data-migrate` and workspace inspection.

## Configuration
Barffine loads configuration in the following order (later items win): defaults → optional TOML file pointed to by `BARFFINE_CONFIG_FILE` → environment variables → `.env` (via `dotenvy`). Keep `.env` around for local runs and promote the same values into your process manager when deploying.

Key variables:

| Variable | Default / Example | Notes |
| --- | --- | --- |
| `BARFFINE_BIND_ADDRESS` | `127.0.0.1:8081` | Socket address for the HTTP listener. |
| `BARFFINE_DATABASE_PATH` | `./data/barffine.db` | Path to the sqlite-only database. |
| `BARFFINE_BASE_URL` / `BARFFINE_PUBLIC_BASE_URL` | Derived from host/port | Used to build absolute links returned to clients. Set both when exposing Barffine behind a proxy. |
| `BARFFINE_SERVER_HOST` / `BARFFINE_SERVER_PORT` | `127.0.0.1` / `8081` | Populate compatibility metadata surfaced to AFFiNE clients. |
| `BARFFINE_SERVER_PATH` / `BARFFINE_SERVER_SUB_PATH` | unset | Mount the API under a prefix when sitting behind a reverse proxy. |
| `AFFINE_VERSION`, `DEPLOYMENT_TYPE`, `SERVER_FLAVOR` | `0.25.0`, `selfhosted`, `allinone` | Advertise compatibility and deployment flavour in `/info`. |
| `BARFFINE_SERVER_FEATURES` | empty | Comma or semicolon separated list enabling feature flags (e.g., `comment,indexer`). |
| `BARFFINE_CRYPTO_PRIVATE_KEY` (`AFFINE_CRYPTO_PRIVATE_KEY`) | autogenerated if missing | Used by `DocTokenSigner` to mint RPC tokens; a random key is generated at startup when not provided. |
| `BARFFINE_ALLOW_GUEST_DEMO_WORKSPACE` | `false` | Allow anonymous demo workspaces. |
| `BARFFINE_PASSWORD_MIN` / `BARFFINE_PASSWORD_MAX` | upstream defaults | Enforce password length guards. |
| `BARFFINE_ENVIRONMENT` (`BARFFINE_ENV`) | unset | Emitted with log events and exported to Logfire. |
| `LOGFIRE_TOKEN` | unset | Enables Logfire export; tracing falls back to `tracing_subscriber` when absent. |
| `RUST_LOG` | `info` | Standard Rust log filter. |
| `BARFFINE_TRACE_*` | unset | Control sampling behaviour for custom tracing (see `server/src/observability.rs`). |

Example `.env`:

```dotenv
AFFINE_VERSION=0.25.0
DEPLOYMENT_TYPE=selfhosted
SERVER_FLAVOR=allinone

BARFFINE_DATABASE_PATH=./data/barffine.db
BARFFINE_BASE_URL=http://127.0.0.1:8081
BARFFINE_PUBLIC_BASE_URL=http://127.0.0.1:8081
BARFFINE_SERVER_NAME="Barffine Server"
BARFFINE_SERVER_HOST=127.0.0.1
BARFFINE_SERVER_PORT=8081

RUST_LOG=info,tower_http=trace,axum=debug
```
